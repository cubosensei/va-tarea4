<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Assignment 4 | Visual Analytics</title>

  <!-- Materialize CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <!-- D3 -->
  <script type="text/javascript" src="libraries/d3/d3.min.js"></script>

  <!-- Internal -->
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col s12">
        <div class="card">
          <div class="card-image">
            <img src="assets/img/city.jpg">
            <span class="card-title">Title</span>
          </div>
          <div class="card-content">
            <p>lorem ipsum</p>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <ul class="collapsible">
          <li>
            <div class="collapsible-header yellow lighten-4"><i class="material-icons">filter_list</i>Click here to filter by department.</div>
            <div class="collapsible-body"><form id="departments"></form></div>
          </li>
        </ul>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="card">
          <div class="card-content">
            <span class="card-title"><span class="badge"><i class="material-icons left">insert_chart</i></span> Motorcycles thievery in Colombia</span>
            <div id="chart1" class="progress"><div class="indeterminate"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <hr>
  
  <div class="container">
    <div class="row">
      <h2 class="section-title">About the vis</h2>
      <div class="col s12 m4">
        <div class="card">
          <div class="card-image red darken-3 noimage">
            <span class="card-title">What</span>
          </div>
          <div class="card-content">
            <p>Dataset Type: Temporal</p>
            <p>Items: Motorcycle thievery report</p>
            <p>Attributes: 
              <ol>
                <li>Date & time (Temporal)</li>
                <li>Department (Categorical)</li>
                <li>Count* (Ordered, Quantitative)</li>
              </ol>
            </p>
            <p><small>*Derived</small></p>
          </div>
        </div>
      </div>
      <div class="col s12 m4">
        <div class="card">
          <div class="card-image yellow darken-3 noimage">
            <span class="card-title">Why</span>
          </div>
          <div class="card-content">
            <ul class="browser-default">
              <li>Lorem ipsum. <b>(x - y)</b></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col s12 m4">
        <div class="card">
          <div class="card-image green darken-1 noimage">
            <span class="card-title">How</span>
          </div>
          <div class="card-content">
            <p>
              <ul>
                <li><ul>
                  <li>[1] (Days) Encode: Arrange, Separate, Order & Align.</li>
                  <li>[1] Facet: Juxtapose.</li>
                  <li>[3] Encode: Arrange, Express.</li>
                  <li>[3] Map: Color (saturation) .</li>
                  <li>[2] Reduce: Filter.</li>
                </ul></li>
                <li>Mark: Area.</li>
                <li>Channels:
                  <ul class="browser-default">
                    <li>[1] Position.</li>
                    <li>[3] Color (saturation).</li>
                  </ul></li>
              </ul>
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="card">
          <div class="card-content">
            <span class="card-title">Insights</span>
            <p>Lorem ipsum</p>
          </div>
        </div>
      </div>
    </div>

  </div>

  <footer class="page-footer grey darken-4">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
          <h5 class="white-text">Visual Analytics</h5>
          <p class="grey-text text-lighten-2">This visualization was developed for the <a href="http://johnguerra.co/classes/visual_analytics_fall_2018/" target="_blank">Visual Analytics</a> class (2018-20) at <a href="https://uniandes.edu.co/" target="_blank">Universidad de los Andes</a>.</p>
        </div>
        <div class="col l4 offset-l2 s12">
          <h5 class="white-text">Related Content</h5>
          <ul>
            <li><a href="https://github.com/cubosensei/va-tarea4" target="_blank">Source Code</a></li>
            <li><a href="#!" target="_blank">Slides</a></li>
            <li><a href="#!" target="_blank">Youtube Video</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-copyright black">
      <div class="container">
      2018 MIT Licenced Content by <a href="http://www.manalco.co" target="_blank">Manuel Alvarado</a>
      </div>
    </div>
  </footer>
  <script type="text/javascript">
    //Materialize Modals
    document.addEventListener('DOMContentLoaded', function() {
      var elems = document.querySelectorAll('.collapsible');
      var instances = M.Collapsible.init(elems);
    });

    //D3
    var rawData;
    var width = d3.select("#chart1").node().getBoundingClientRect().width-80;
    var cellSize = width/52;
    var height = cellSize * 9;
    var countDay = d => (d.getDay() + 6) % 7;
    function pathMonth(t) {
      const n = 7;
      const d = Math.max(0, Math.min(n, countDay(t)));
      const w = d3.timeMonday.count(d3.timeYear(t), t);
      return `${d === 0 ? `M${w * cellSize},0`
          : d === n ? `M${(w + 1) * cellSize},0`
          : `M${(w + 1) * cellSize},0V${d * cellSize}H${w * cellSize}`}V${n * cellSize}`;
    }
    var format = d3.format("+.2%");
    var formatDate = d3.timeFormat("%x");
    var formatDay = d => "SMTWTFS"[d.getDay()];
    var formatMonth = d3.timeFormat("%b");

    d3.csv('assets/data/Hurto_de_motocicletas_2010-2017.csv').then(
      function(data) {
        data.sort( (a,b) => d3.ascending(new Date(a.fecha), new Date(b.fecha)));
        rawData = data;

        var departments = data.columns.splice(1,32);
        departments.forEach(function(d,i){
          d3.select('#departments')
            .append("div")
            .attr("class","col s2")
            .html('<label><input type="checkbox" class="department-checkbox" id="'+encodeURI(d.toLowerCase())+'" checked><span>'+d[0].toUpperCase()+d.slice(1).toLowerCase()+'</span></label>');
        });
        d3.select('#departments')
            .append("div")
            .attr("class","clearfix");
        drawCalendar("All");
        d3.select("#chart1").attr("class","");
      }
    );

    function formatYear(s){
      var d = new Date(s);
      return d.getFullYear();
    }

    function drawCalendar(filter){
      width = d3.select("#chart1").node().getBoundingClientRect().width-80;
      cellSize = width/52;
      height = cellSize * 9;
      d3.select("#chart1").html("");
      var color = d3.scaleSequential(d3.interpolateBlues).domain([0, d3.max(rawData, d=> +d[filter])]);

      var years = d3.nest()
        .key(d => formatYear(d.fecha))
        .entries(rawData)
        .reverse();
      
      var svg = d3.select("#chart1")
        .append("svg")
        .style("font", "10px sans-serif")
        .style("width", "100%")
        .style("height", height*years.length);

      const year = svg.selectAll("g")
          .data(years)
          .enter().append("g")
            .attr("transform", (d, i) => `translate(40,${height * i + cellSize * 1.5})`);
      year.append("text")
            .attr("x", -5)
            .attr("y", -5)
            .attr("font-weight", "bold")
            .attr("text-anchor", "end")
            .text(d => d.key);

        year.append("g")
            .attr("text-anchor", "end")
          .selectAll("text")
          .data((d3.range(7)).map(i => new Date(1995, 0, i)))
          .enter().append("text")
            .attr("x", -5)
            .attr("y", d => (countDay(d) + 0.5) * cellSize)
            .attr("dy", "0.31em")
            .text(formatDay);

        year.append("g")
          .selectAll("rect")
          .data(d => d.values)
          .enter().append("rect")
            .attr("width", cellSize - 1)
            .attr("height", cellSize - 1)
            .attr("x", d => d3.timeMonday.count(d3.timeYear(new Date(d.fecha)), new Date(d.fecha)) * cellSize + 0.5)
            .attr("y", d => countDay(new Date(d.fecha)) * cellSize + 0.5)
            .attr("fill", d => color(d[filter]))
          .append("title")
            .text(d => `${formatDate(new Date(d.fecha))}: ${d[filter]} reports`);

        const month = year.append("g")
          .selectAll("g")
          .data(d => d3.timeMonths(d3.timeMonth(new Date(d.values[0].fecha)), new Date(d.values[d.values.length - 1].fecha)))
          .enter().append("g");

        month.filter((d, i) => i).append("path")
            .attr("fill", "none")
            .attr("stroke", "#fff")
            .attr("stroke-width", 3)
            .attr("d", pathMonth);

        month.append("text")
            .attr("x", d => d3.timeMonday.count(d3.timeYear(d), d3.timeMonday.ceil(d)) * cellSize + 2)
            .attr("y", -5)
            .text(formatMonth);
    }

    d3.select("input")
      .property("checked", true)
      .on("change", function(){
        console.log("OMG");
      });

    window.onresize = function(event) {
      drawCalendar();
    }
  </script>
</body>